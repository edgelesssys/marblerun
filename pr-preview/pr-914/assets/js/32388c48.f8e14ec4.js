"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[6478],{28453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>a});var i=n(96540);const o={},s=i.createContext(o);function t(e){const r=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),i.createElement(s.Provider,{value:r},e.children)}},28879:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"building-marbles/occlum","title":"Building a service: Occlum","description":"Running an Occlum app with MarbleRun requires some changes to its manifest.","source":"@site/versioned_docs/version-1.4/building-marbles/occlum.md","sourceDirName":"building-marbles","slug":"/building-marbles/occlum","permalink":"/marblerun/pr-preview/pr-914/1.4/building-marbles/occlum","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/versioned_docs/version-1.4/building-marbles/occlum.md","tags":[],"version":"1.4","frontMatter":{},"sidebar":"docs","previous":{"title":"Gramine","permalink":"/marblerun/pr-preview/pr-914/1.4/building-marbles/gramine"},"next":{"title":"Coordinator client API","permalink":"/marblerun/pr-preview/pr-914/1.4/reference/coordinator"}}');var o=n(74848),s=n(28453);const t={},a="Building a service: Occlum",c={},l=[{value:"Requirements",id:"requirements",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Premain executable",id:"premain-executable",level:3},{value:"Environment variables",id:"environment-variables",level:3},{value:"Resource limits",id:"resource-limits",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Error message: <code>fatal error: failed to reserve page summary memory</code>",id:"error-message-fatal-error-failed-to-reserve-page-summary-memory",level:3},{value:"Error message: <code>Error returned from the p_sgx_get_quote_config API</code>",id:"error-message-error-returned-from-the-p_sgx_get_quote_config-api",level:3},{value:"Other issues",id:"other-issues",level:3}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"building-a-service-occlum",children:"Building a service: Occlum"})}),"\n",(0,o.jsx)(r.p,{children:"Running an Occlum app with MarbleRun requires some changes to its manifest."}),"\n",(0,o.jsx)(r.h2,{id:"requirements",children:"Requirements"}),"\n",(0,o.jsxs)(r.p,{children:["Set up an environment to create Occlum images. For an easy start, we recommend using the official ",(0,o.jsx)(r.a,{href:"https://hub.docker.com/r/occlum/occlum",children:"Occlum Docker image"}),".\nFor a working DCAP remote attestation environment, we recommend ",(0,o.jsx)(r.a,{href:"/marblerun/pr-preview/pr-914/1.4/deployment/platforms/",children:"our platform deployment guide"}),"."]}),"\n",(0,o.jsxs)(r.p,{children:["To build your service, you can start with ",(0,o.jsx)(r.a,{href:"https://github.com/occlum/occlum#introduction",children:"Occlum's Introduction"})," to get your application up and running and then come back here to adapt it for use with MarbleRun."]}),"\n",(0,o.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsx)(r.h3,{id:"premain-executable",children:"Premain executable"}),"\n",(0,o.jsxs)(r.p,{children:["Add our pre-built ",(0,o.jsx)(r.a,{href:"https://github.com/edgelesssys/marblerun/releases/latest/download/premain-libos",children:"premain-libos"})," executable to your Occlum image, e.g., by copying it to ",(0,o.jsx)(r.code,{children:"image/bin/premain-libos"}),". By default, Occlum restricts executable files to the ",(0,o.jsx)(r.code,{children:"/bin"})," directory. If you placed the ",(0,o.jsx)(r.code,{children:"premain-libos"})," binary at a different path, you must adjust this setting accordingly."]}),"\n",(0,o.jsxs)(r.p,{children:["Finally, define the original entry point for your Occlum instance as the first ",(0,o.jsx)(r.code,{children:"Argv"})," parameter for your Marble in MarbleRun's ",(0,o.jsx)(r.code,{children:"manifest.json"}),". See ",(0,o.jsx)(r.a,{href:"/marblerun/pr-preview/pr-914/1.4/workflows/define-manifest",children:"Defining a manifest"})," for more information on how to define the ",(0,o.jsx)(r.code,{children:"Argv"})," parameters. This lets MarbleRun launch your application after it succeeded in authenticating with the Coordinator and provides entrypoint pinning similar to the one offered in ",(0,o.jsx)(r.code,{children:"Occlum.json"}),"."]}),"\n",(0,o.jsx)(r.h3,{id:"environment-variables",children:"Environment variables"}),"\n",(0,o.jsxs)(r.p,{children:["The Marble needs to retrieve the MarbleRun-specific configuration parameters via environment variables, as ",(0,o.jsx)(r.a,{href:"/marblerun/pr-preview/pr-914/1.4/workflows/add-service",children:'described under Step 3 in "Adding a service."'})]}),"\n",(0,o.jsxs)(r.p,{children:["To pass environment variables to the enclave, Occlum requires them to be specified in the ",(0,o.jsx)(r.code,{children:"env"})," section in ",(0,o.jsx)(r.code,{children:"Occlum.json"}),"."]}),"\n",(0,o.jsxs)(r.p,{children:["You can provide default (hardcoded) values under ",(0,o.jsx)(r.code,{children:"default"}),", and you may also define them additionally as ",(0,o.jsx)(r.code,{children:"untrusted"})," in case you want to allow changes to the Marble configuration after build time."]}),"\n",(0,o.jsx)(r.p,{children:"For example, consider this configuration:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-javascript",children:'"env": {\n    "default": [\n        "OCCLUM=yes",\n        "EDG_MARBLE_COORDINATOR_ADDR=localhost:2001",\n        "EDG_MARBLE_TYPE=hello",\n        "EDG_MARBLE_UUID_FILE=uuid",\n        "EDG_MARBLE_DNS_NAMES=localhost"\n    ],\n    "untrusted": [\n        "EDG_MARBLE_COORDINATOR_ADDR",\n        "EDG_MARBLE_TYPE",\n        "EDG_MARBLE_UUID_FILE",\n        "EDG_MARBLE_DNS_NAMES"\n    ]\n},\n'})}),"\n",(0,o.jsx)(r.p,{children:"This will allow you to embed the expected default values during build time. It also lets the user/host system change them during run time when a non-default Coordinator configuration is used."}),"\n",(0,o.jsx)(r.h3,{id:"resource-limits",children:"Resource limits"}),"\n",(0,o.jsx)(r.p,{children:"The premain process is written in Go. The enclave must have enough resources for the Go runtime and additional memory to launch your application."}),"\n",(0,o.jsx)(r.p,{children:"We recommend starting with the following values, which should work fine for light-weight to medium memory-demanding applications:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-javascript",children:'"user_space_size": "2048MB",\n"default_mmap_size": "900MB"\n"max_num_of_threads": 64\n'})}),"\n",(0,o.jsxs)(r.p,{children:["In case you are running into issues with memory demands, check out the ",(0,o.jsx)(r.a,{href:"https://github.com/occlum/occlum/blob/master/docs/resource_config_guide.md",children:"Resource Configuration Guide"})," provided by the Occlum team to debug and resolve issues related to resource limits."]}),"\n",(0,o.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,o.jsxs)(r.h3,{id:"error-message-fatal-error-failed-to-reserve-page-summary-memory",children:["Error message: ",(0,o.jsx)(r.code,{children:"fatal error: failed to reserve page summary memory"})]}),"\n",(0,o.jsxs)(r.p,{children:["If you receive this error during the launch of your Occlum image, make sure you allocated enough memory in ",(0,o.jsx)(r.code,{children:"Occlum.json"})," ",(0,o.jsx)(r.a,{href:"#resource-limits",children:"as described above"}),". The most important parameters are ",(0,o.jsx)(r.code,{children:"user_space_size"})," and ",(0,o.jsx)(r.code,{children:"default_mmap_size"}),"."]}),"\n",(0,o.jsxs)(r.h3,{id:"error-message-error-returned-from-the-p_sgx_get_quote_config-api",children:["Error message: ",(0,o.jsx)(r.code,{children:"Error returned from the p_sgx_get_quote_config API"})]}),"\n",(0,o.jsx)(r.p,{children:"If Occlum crashes during the quote generation with the following error message:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"[get_platform_quote_cert_data ../qe_logic.cpp:346] Error returned from the p_sgx_get_quote_config API. 0xe019\nthread '<unnamed>' panicked at 'assertion failed: `(left == right)`\nleft: `SGX_QL_SUCCESS`,\nright: `SGX_QL_NETWORK_ERROR`: fail to launch QE', src/util/sgx/dcap/quote_generator.rs:22:13\n"})}),"\n",(0,o.jsxs)(r.p,{children:["You might need to check the DCAP configuration on your system. Note that when using the Docker image, the local Intel DCAP configuration must be correctly set ",(0,o.jsx)(r.strong,{children:"inside the container."})]}),"\n",(0,o.jsx)(r.h3,{id:"other-issues",children:"Other issues"}),"\n",(0,o.jsx)(r.p,{children:"If you are running into other issues, Occlum's error logging might help:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"OCCLUM_LOG_LEVEL=error occlum run /bin/premain-libos\n"})})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);