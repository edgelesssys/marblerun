<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-1.7 docs-doc-page docs-doc-id-architecture/security" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Key management and cryptographic primitives | MarbleRun</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.edgeless.systems/marblerun/pr-preview/pr-890/1.7/architecture/security"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.7"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.7"><meta data-rh="true" name="docsearch:version" content="1.7"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.7"><meta data-rh="true" property="og:title" content="Key management and cryptographic primitives | MarbleRun"><meta data-rh="true" name="description" content="MarbleRun protects and isolates your deployments and workloads. To that end, cryptography is the foundation that ensures the confidentiality and integrity of all components."><meta data-rh="true" property="og:description" content="MarbleRun protects and isolates your deployments and workloads. To that end, cryptography is the foundation that ensures the confidentiality and integrity of all components."><link data-rh="true" rel="icon" href="/marblerun/pr-preview/pr-890/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.edgeless.systems/marblerun/pr-preview/pr-890/1.7/architecture/security"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/marblerun/pr-preview/pr-890/1.7/architecture/security" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.edgeless.systems/marblerun/pr-preview/pr-890/1.7/architecture/security" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Keys and cryptography","item":"https://docs.edgeless.systems/marblerun/pr-preview/pr-890/1.7/architecture/security"}]}</script><script src="/marblerun/gtagman.js" async data-cookieconsent="ignore"></script><link rel="stylesheet" href="/marblerun/pr-preview/pr-890/assets/css/styles.85a93fef.css">
<script src="/marblerun/pr-preview/pr-890/assets/js/runtime~main.fba90e99.js" defer="defer"></script>
<script src="/marblerun/pr-preview/pr-890/assets/js/main.cbd77e08.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/marblerun/pr-preview/pr-890/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/marblerun/pr-preview/pr-890/"><div class="navbar__logo"><img src="/marblerun/pr-preview/pr-890/img/logo.svg" alt="MarbleRun Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/marblerun/pr-preview/pr-890/img/logo.svg" alt="MarbleRun Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/marblerun/pr-preview/pr-890/1.7/architecture/security">1.7</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/next/architecture/security">Next</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/architecture/security">1.8</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/marblerun/pr-preview/pr-890/1.7/architecture/security">1.7</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.6/architecture/security">1.6</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.5/architecture/security">1.5</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.4/architecture/security">1.4</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.3/architecture/security">1.3</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.2/architecture/security">1.2</a></li><li><a class="dropdown__link" href="/marblerun/pr-preview/pr-890/1.1/">1.1</a></li></ul></div><a href="https://github.com/edgelesssys/marblerun" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-1.7"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/marblerun/pr-preview/pr-890/1.7/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/getting-started/installation"><span title="Getting started" class="categoryLinkLabel_W154">Getting started</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/features/manifest"><span title="Features" class="categoryLinkLabel_W154">Features</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/deployment/kubernetes"><span title="Deployment" class="categoryLinkLabel_W154">Deployment</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/workflows/define-manifest"><span title="Workflows" class="categoryLinkLabel_W154">Workflows</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/marblerun/pr-preview/pr-890/1.7/architecture/concepts"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/marblerun/pr-preview/pr-890/1.7/architecture/concepts"><span title="Concepts" class="linkLabel_WmDU">Concepts</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/marblerun/pr-preview/pr-890/1.7/architecture/coordinator"><span title="Coordinator" class="linkLabel_WmDU">Coordinator</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/marblerun/pr-preview/pr-890/1.7/architecture/marbles"><span title="Marbles" class="linkLabel_WmDU">Marbles</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/marblerun/pr-preview/pr-890/1.7/architecture/security"><span title="Keys and cryptography" class="linkLabel_WmDU">Keys and cryptography</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/building-marbles/ego"><span title="Building Marbles" class="categoryLinkLabel_W154">Building Marbles</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/marblerun/pr-preview/pr-890/1.7/reference/coordinator"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->MarbleRun<!-- --> <b>1.7</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/marblerun/pr-preview/pr-890/architecture/security">latest version</a></b> (<!-- -->1.8<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/marblerun/pr-preview/pr-890/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Keys and cryptography</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.7</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Key management and cryptographic primitives</h1></header>
<p>MarbleRun protects and isolates your deployments and workloads. To that end, cryptography is the foundation that ensures the confidentiality and integrity of all components.
Evaluating the security of MarbleRun requires a precise understanding of the cryptographic primitives and keys used.
The following gives an overview of the architecture and explains the technical details.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="high-level-architecture">High-level architecture<a href="#high-level-architecture" class="hash-link" aria-label="Direct link to High-level architecture" title="Direct link to High-level architecture" translate="no">​</a></h2>
<p>The <a class="" href="/marblerun/pr-preview/pr-890/1.7/architecture/coordinator">Coordinator</a> and the <a class="" href="/marblerun/pr-preview/pr-890/1.7/architecture/marbles">Marbles</a> run inside SGX Enclaves. See <a href="https://www.intel.com/content/www/us/en/developer/tools/software-guard-extensions/overview.html" target="_blank" rel="noopener noreferrer" class="">Intel&#x27;s documentation</a> on the architecture details and cryptographic primitives of SGX.</p>
<p>MarbleRun uses cryptography for the following tasks.</p>
<ul>
<li class="">Authentication and authorization</li>
<li class="">Establishment of a public key infrastructure (PKI) for MarbleRun</li>
<li class="">Encryption of network traffic via mutual TLS between enclaves</li>
<li class="">Encrypting persistent state</li>
</ul>
<p>The following diagram gives an overview of the architecture and the components.</p>
<p><img decoding="async" loading="lazy" alt="Security architecture" src="/marblerun/pr-preview/pr-890/assets/images/security_architecture-cc588bcf10227634bbe09c72be88d92d.svg" width="1500" height="810" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="authentication-and-authorization">Authentication and authorization<a href="#authentication-and-authorization" class="hash-link" aria-label="Direct link to Authentication and authorization" title="Direct link to Authentication and authorization" translate="no">​</a></h2>
<p>MarbleRun uses the SGX <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/attestation">remote attestation</a> capability to authenticate the Coordinator and the Marble enclaves.
For authorization, the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/manifest">manifest</a> defines the Marble&#x27;s access to secrets and keys after successful attestation.
Furthermore, MarbleRun&#x27;s <a class="" href="/marblerun/pr-preview/pr-890/1.7/workflows/define-manifest#roles">RBAC</a> attaches <a class="" href="/marblerun/pr-preview/pr-890/1.7/workflows/define-manifest#users">users&#x27;</a> identities to roles in the manifest.
Each role is associated with a set of operations the user can perform in the deployment.
Users are authenticated by the Coordinator using an RSA or ECDSA public key defined in the manifest.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="public-key-infrastructure-and-certificate-authority">Public key infrastructure and certificate authority<a href="#public-key-infrastructure-and-certificate-authority" class="hash-link" aria-label="Direct link to Public key infrastructure and certificate authority" title="Direct link to Public key infrastructure and certificate authority" translate="no">​</a></h2>
<p>The Coordinator establishes a public key infrastructure (PKI) for MarbleRun and acts as the certificate authority (CA).
The goal of the PKI is to make authentication of confidential applications based on remote attestation accessible and usable.
The Coordinator provides an <a class="" href="/marblerun/pr-preview/pr-890/1.7/reference/coordinator">API</a> for retrieving an SGX attestation statement that embeds its <em>Root CA Certificate</em> in the user-defined body.
By verifying the statement, clients can verify the certificate&#x27;s authenticity and, thereby, the MarbleRun CA.
See the <a href="#attested-tls-atls" class="">attested TLS</a> section for details behind that concept.
All MarbleRun clients and Marbles can then use the attested <em>Root CA Certificate</em> for authenticating TLS connections.
This is further illustrated conceptually in the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/attestation">attestation</a> section. The following focuses on the cryptographic primitives.
The Coordinator generates a root X.509 certificate and corresponding asymmetric key pair during initialization.
The <a href="https://www.secg.org/sec1-v2.pdf#page=49" target="_blank" rel="noopener noreferrer" class="">Elliptic Curve Digital Signature Algorithm (ECDSA)</a> is used with curve <a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf#page=111" target="_blank" rel="noopener noreferrer" class="">P256</a>.
The <em>Root CA Certificate</em> has no expiry date and lives as long as the MarbleRun deployment.</p>
<p>Alongside the <em>Root CA Certificate</em>, the Coordinator generates an X.509 <em>Intermediate Certificate</em> and corresponding asymmetric key pair, again using ECDSA with P256.
The <em>Intermediate Certificate</em> is signed by the Coordinator&#x27;s <em>Root CA Certificate</em> and rotated with every manifest update.
When you push an update to the manifest (for example, bump up the <em>SecurityVersion</em> of a Marble), the <em>Intermediate Certificate</em> will change.
Marble instances of the new version won&#x27;t authenticate with instances of the old version and vice versa.
Hence, no data flow is happening between different <em>SecurityVersions</em> of your application.
However, the <em>Root CA Certificate</em> doesn&#x27;t change. So you can still verify the Coordinator and your application from the outside and ensure it&#x27;s the same instance you might have interacted with.
Applications interacting with the MarbleRun deployment should use the intermediate certificate as CA to make manifest updates observable:
If the manifest changes, connections to the deployment will fail.
The application user can then review the changes and install the new intermediate certificate to approve them.
If such observability isn&#x27;t required, the application can use the root certificate as CA.
In that case, the application will continue to work even if the manifest changes.</p>
<p>The Coordinator creates a second certificate with the same key material as the <em>Intermediate Certificate</em> called the <em>Marble Root Certificate</em>.
In that sense, they&#x27;re siblings containing the same public key.
However, while the <em>Intermediate Certificate</em> is signed by the <em>Root Certificate</em>, the <em>Marble Root Certificate</em> is self-signed using its private key.
The goal here is to implement a  <a href="https://www.ssltrust.com.au/blog/understanding-certificate-cross-signing" target="_blank" rel="noopener noreferrer" class="">cross-signed certificate chain</a>.
In that way, the Marbles see the <em>Marble Root Certificate</em> as a self-signed root certificate. Hence, they&#x27;re dealing with a terminating certificate chain without knowing about the Coordinator&#x27;s <em>Root CA Certificate</em>.
The &quot;outside world&quot; sees an intermediate certificate signed by the Coordinator&#x27;s <em>Root CA Certificate</em>.
The Coordinator generates a unique leaf <em>Marble Certificate</em> and corresponding key pair using ECDSA with P256 for every Marble.
The <em>Marble Root Certificate</em> signs the <em>Marble Certificate</em>.
The <em>Marble Certificate</em> is provisioned to the Marble&#x27;s enclave via the secure channel established during the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/attestation">attestation procedure</a>.
Depending on the Marble&#x27;s runtime, the certificate can be used <a class="" href="/marblerun/pr-preview/pr-890/1.7/workflows/add-service#make-your-service-use-the-provided-tls-credentials">manually</a> or <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/transparent-TLS">automatically</a> to establish mutually authenticated TLS connections.</p>
<p><img decoding="async" loading="lazy" alt="PKI Certificate chain" src="/marblerun/pr-preview/pr-890/assets/images/cert-chain-cd5982cb3749a86f334b4135fb5d03e6.svg" width="1171" height="684" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="attested-tls-atls">Attested TLS (aTLS)<a href="#attested-tls-atls" class="hash-link" aria-label="Direct link to Attested TLS (aTLS)" title="Direct link to Attested TLS (aTLS)" translate="no">​</a></h2>
<p>In a confidential computing environment, attested TLS (aTLS) can establish secure connections between two parties using the remote attestation features of the confidential computing components.
With aTLS, the party to be authenticated binds its TLS certificate to an attestation statement.
For example, it embeds the certificate&#x27;s public key into the attestation statement.
Instead of relying on a certificate authority, aTLS uses this attestation statement to establish trust in the certificate.
The protocol can be used by clients to verify a server certificate, by a server to verify a client certificate, or for mutual verification (mutual aTLS).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="encryption-of-state">Encryption of state<a href="#encryption-of-state" class="hash-link" aria-label="Direct link to Encryption of state" title="Direct link to Encryption of state" translate="no">​</a></h2>
<p>The Coordinator holds MarbleRun&#x27;s state, which consists of the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/manifest">manifest</a>, the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/secrets-management">managed secrets</a>, and the <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/attestation">certificates for its CA</a>.
The state is stored encrypted in persistent storage. For this, MarbleRun uses <a href="https://www.rfc-editor.org/rfc/rfc5116#section-5.1" target="_blank" rel="noopener noreferrer" class="">AES128-GCM</a> and a generated 16-byte data encryption key (DEK).
The Coordinator encrypts the DEK with a key encryption key (KEK).
MarbleRun uses an <a href="#seal-key" class="">SGX seal key</a> as its KEK.
Hence, if the Coordinator is restarted on the same CPU, it can obtain the same KEK from the CPU, decrypt the DEK, and recover its state autonomously.</p>
<p><img decoding="async" loading="lazy" alt="Encrypted state single instance" src="/marblerun/pr-preview/pr-890/assets/images/enc-state-single-a918aaf42a8cad37276129bb620f4bd7.svg" width="521" height="381" class="img_ev3q"></p>
<p>If the Coordinator is restarted on a different CPU, it won&#x27;t be able to obtain the same SGX seal key from the CPU.
To address this, MarbleRun provides a <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/recovery#recovery">recovery feature</a>.
The manifest allows for specifying a designated Recovery Key. The Recovery Key is a RSA public key. Upon startup, the Coordinator encrypts the DEK with this public key and returns it to the user.
In case of a recovery event, the user decrypts the DEK locally and <a class="" href="/marblerun/pr-preview/pr-890/1.7/workflows/recover-coordinator">uploads it to the Coordinator</a>.
The Coordinator will decrypt the state with the DEK and proceed with operations.</p>
<p>For <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/recovery#multi-party-recovery">multi-party use cases</a>, MarbleRun allows splitting the Recovery Key between parties.
Every recovery party is defined in the manifest with its own public RSA key.
The Coordinator generates a share of the recovery secret for every party and encrypts it with the corresponding RSA key.
During a recovery event, every party will upload their share of the secret, which are all XORed together by the Coordinator to receive the combined key for decrypting the DEK.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="distributed-coordinator">Distributed Coordinator<a href="#distributed-coordinator" class="hash-link" aria-label="Direct link to Distributed Coordinator" title="Direct link to Distributed Coordinator" translate="no">​</a></h3>
<p>The <a class="" href="/marblerun/pr-preview/pr-890/1.7/features/recovery#distributed-coordinator">distributed Coordinator</a> works similarly. However, all Coordinators share the same state stored encrypted in the Kubernetes <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreferrer" class="">Secret</a> called <em>marblerun-state</em>.
In contrast to the single instance, the KEK is generated at start-up by the first instance.
The existing Coordinators authenticate every new Coordinator instance via remote attestation, and the KEK is subsequently shared via the secure and attested TLS connection.
Every Coordinator instance uses an SGX seal key to seal the KEK into a Kubernetes <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" target="_blank" rel="noopener noreferrer" class="">ConfigMap</a> called <em>marblerun-sealed-kek</em>.</p>
<p><img decoding="async" loading="lazy" alt="Encrypted state distributed" src="/marblerun/pr-preview/pr-890/assets/images/enc-state-distributed-00216f72449c384481d33c1929986804.svg" width="891" height="531" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="seal-key">Seal key<a href="#seal-key" class="hash-link" aria-label="Direct link to Seal key" title="Direct link to Seal key" translate="no">​</a></h3>
<p>There are two types of <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-intel-sgx-sealing.html" target="_blank" rel="noopener noreferrer" class="">SGX seal keys</a>:</p>
<ul>
<li class="">Unique key: This key is derived from the UniqueID (MRENCLAVE) of the enclave. This means that only instances of the same enclave can derive this key.</li>
<li class="">Product key: This key is derived from the SignerID (MRSIGNER), ProductID, and SecurityVersion of the enclave. If the signer of the enclave creates a new enclave with the same ProductID and the same or higher SecurityVersion, that enclave can derive the same key.</li>
</ul>
<p>By default, MarbleRun uses the product key as the KEK.
This allows the Coordinator to be updated without manual recovery.
If you don&#x27;t want to trust the signing entity, you can <a class="" href="/marblerun/pr-preview/pr-890/1.7/workflows/define-manifest#config">enable sealing with the unique key</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/edgelesssys/marblerun/edit/master/docs/versioned_docs/version-1.7/architecture/security.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/marblerun/pr-preview/pr-890/1.7/architecture/marbles"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Marbles</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/marblerun/pr-preview/pr-890/1.7/building-marbles/ego"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EGo</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#high-level-architecture" class="table-of-contents__link toc-highlight">High-level architecture</a></li><li><a href="#authentication-and-authorization" class="table-of-contents__link toc-highlight">Authentication and authorization</a></li><li><a href="#public-key-infrastructure-and-certificate-authority" class="table-of-contents__link toc-highlight">Public key infrastructure and certificate authority</a></li><li><a href="#attested-tls-atls" class="table-of-contents__link toc-highlight">Attested TLS (aTLS)</a></li><li><a href="#encryption-of-state" class="table-of-contents__link toc-highlight">Encryption of state</a><ul><li><a href="#distributed-coordinator" class="table-of-contents__link toc-highlight">Distributed Coordinator</a></li><li><a href="#seal-key" class="table-of-contents__link toc-highlight">Seal key</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/edgelesssys/marblerun" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.edgeless.systems/#footer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Newsletter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/EdgelessSystems" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/edgeless-systems/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCOOInN0sCv6icUesisYIDeA" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.edgeless.systems/imprint/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.edgeless.systems/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="javascript: Cookiebot.renew()" class="footer__link-item">Cookie Settings</a></li><li class="footer__item"><a href="https://www.edgeless.systems/contact-us/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Edgeless Systems</div></div></div></footer></div>
</body>
</html>