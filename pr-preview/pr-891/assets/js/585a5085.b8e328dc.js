"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1792],{28453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>o});var s=n(96540);const i={},t=s.createContext(i);function a(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(t.Provider,{value:r},e.children)}},55750:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"workflows/add-service","title":"Adding a service","description":"Adding a service to your application requires three steps, which are described in the following.","source":"@site/docs/workflows/add-service.md","sourceDirName":"workflows","slug":"/workflows/add-service","permalink":"/marblerun/pr-preview/pr-891/next/workflows/add-service","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/docs/workflows/add-service.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Set a manifest","permalink":"/marblerun/pr-preview/pr-891/next/workflows/set-manifest"},"next":{"title":"Verify a deployment","permalink":"/marblerun/pr-preview/pr-891/next/workflows/verification"}}');var i=n(74848),t=n(28453);const a={},o="Adding a service",l={},c=[{value:"<strong>Step 1:</strong> Get your service ready for MarbleRun",id:"step-1-get-your-service-ready-for-marblerun",level:2},{value:"Make your service use the provided TLS credentials",id:"make-your-service-use-the-provided-tls-credentials",level:3},{value:"<strong>Step 2:</strong> Define your service in the manifest",id:"step-2-define-your-service-in-the-manifest",level:2},{value:"<strong>Step 2.1:</strong> Define the enclave software package",id:"step-21-define-the-enclave-software-package",level:3},{value:"EGo / EdgelessRT",id:"ego--edgelessrt",level:4},{value:"Gramine",id:"gramine",level:4},{value:"Occlum",id:"occlum",level:4},{value:"<strong>Step 2.2:</strong> Define the parameters",id:"step-22-define-the-parameters",level:3},{value:"<strong>Step 3:</strong> Start your service",id:"step-3-start-your-service",level:2},{value:"<strong>Step 4:</strong> Deploy your service with Kubernetes",id:"step-4-deploy-your-service-with-kubernetes",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"adding-a-service",children:"Adding a service"})}),"\n",(0,i.jsx)(r.p,{children:"Adding a service to your application requires three steps, which are described in the following."}),"\n",(0,i.jsxs)(r.h2,{id:"step-1-get-your-service-ready-for-marblerun",children:[(0,i.jsx)(r.strong,{children:"Step 1:"})," Get your service ready for MarbleRun"]}),"\n",(0,i.jsxs)(r.p,{children:["To get your service ready for MarbleRun, you need to rebuild it with one of the supported ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/features/runtimes",children:"runtimes"}),":"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/building-marbles/ego",children:"EGo"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"https://github.com/edgelesssys/marblerun/tree/master/samples/helloc++",children:"Edgeless RT"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/building-marbles/gramine",children:"Gramine"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/building-marbles/occlum",children:"Occlum"})}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"make-your-service-use-the-provided-tls-credentials",children:"Make your service use the provided TLS credentials"}),"\n",(0,i.jsxs)(r.p,{children:["Skip this step, when using EGo with ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/features/transparent-TLS",children:"TTLS"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Quick refresher: MarbleRun's Coordinator issues TLS credentials for each verified Marble (i.e., a service running in a secure enclave) as is described in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/features/secrets-management",children:"secrets management chapter"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["The TLS X.509 certificate and the corresponding private key can be securely passed to a service through files, environment variables, or command line arguments. This is defined in the manifest as is described in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/workflows/define-manifest#marbles",children:"writing a manifest hands-on"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Make sure that your service reads the credentials from one of these sources, e.g., the file ",(0,i.jsx)(r.code,{children:"/tmp/mycert.cert"})," or the environment variable ",(0,i.jsx)(r.code,{children:"MY_PRIVATE_KEY"}),", and uses them for internal and external connections. If you're lucky, your service already does this and you don't need to change a thing in the code."]}),"\n",(0,i.jsxs)(r.h2,{id:"step-2-define-your-service-in-the-manifest",children:[(0,i.jsx)(r.strong,{children:"Step 2:"})," Define your service in the manifest"]}),"\n",(0,i.jsx)(r.p,{children:"Now that your service is ready, you need to make two types of entries in the manifest regarding its properties and parameters."}),"\n",(0,i.jsxs)(r.h3,{id:"step-21-define-the-enclave-software-package",children:[(0,i.jsx)(r.strong,{children:"Step 2.1:"})," Define the enclave software package"]}),"\n",(0,i.jsxs)(r.p,{children:["As is described in more detail in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/workflows/define-manifest#packages",children:"writing a manifest hands-on"}),", the manifest contains a section ",(0,i.jsx)(r.code,{children:"Packages"}),", in which allowed enclave software packages are defined."]}),"\n",(0,i.jsx)(r.h4,{id:"ego--edgelessrt",children:"EGo / EdgelessRT"}),"\n",(0,i.jsxs)(r.p,{children:["To add an entry for your EGo / EdgelessRT service, run the ",(0,i.jsx)(r.code,{children:"oesign"})," tool on the enclave file you built in the previous step as follows. (",(0,i.jsx)(r.code,{children:"oesign"})," is installed with ",(0,i.jsx)(r.a,{href:"https://github.com/edgelesssys/edgelessrt",children:"Edgeless RT"}),".)"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"oesign eradump -e enclave.signed\n"})}),"\n",(0,i.jsx)(r.p,{children:"The tool's output is similar to the following."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\n    "UniqueID": "6b2822ac2585040d4b9397675d54977a71ef292ab5b3c0a6acceca26074ae585",\n    "SignerID": "5826218dbe96de0d7b3b1ccf70ece51457e71e886a3d4c1f18b27576d22cdc74",\n    "SecurityVersion": 1,\n    "ProductID": 3\n}\n'})}),"\n",(0,i.jsx)(r.h4,{id:"gramine",children:"Gramine"}),"\n",(0,i.jsxs)(r.p,{children:["To add an entry for your Gramine service, run the ",(0,i.jsx)(r.code,{children:"gramine-sgx-get-token"})," tool on the ",(0,i.jsx)(r.code,{children:".sig"})," file you built in the previous step as follows. (",(0,i.jsx)(r.code,{children:"gramine-sgx-get-token"})," is installed with ",(0,i.jsx)(r.a,{href:"https://github.com/gramineproject/gramine/",children:"Gramine"}),".)"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"gramine-sgx-get-token --sig hello.sig\n"})}),"\n",(0,i.jsx)(r.p,{children:"The tool's output is similar to the following."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:"Attributes:\n    mr_enclave:  72612ea17be998f098459ff3cdc0daa0d592cec85115db8e152b10fc6df033a7\n    mr_signer:   ed81204cd726dcff2dc4c498bdfcef63a2b02009ef188e7e2914c37a7e99b547\n    isv_prod_id: 1\n    isv_svn:     3\n    attr.flags:  0600000000000000\n    attr.xfrm:   1f00000000000000\n    misc_select: 00000000\n    misc_mask:   00000000\n    modulus:     09d6497ec75a05a2280974b7e5b39422...\n    exponent:    3\n    signature:   4b6db90216e6a5e8447812f7f0107317...\n    date:        2021-08-18\n"})}),"\n",(0,i.jsx)(r.h4,{id:"occlum",children:"Occlum"}),"\n",(0,i.jsx)(r.p,{children:"To add an entry for your Occlum service, run the MarbleRun CLI on the Occlum instance you built in the previous step as follows."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"marblerun sgxsdk-package-info ./occlum-instance\n"})}),"\n",(0,i.jsx)(r.p,{children:"The output is similar to the following."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:"PackageProperties for Occlum image at './occlum-instance':\nUniqueID (MRENCLAVE)      : ccad2391e0b79d9108209135c26b2c276c5a24f4f55bc67ccf5ab90fd3f5fc22\nSignerID (MRSIGNER)       : 83d719e77deaca1470f6baf62a4d774303c899db69020f9c70ee1dfc08c7ce9e\nProductID (ISVPRODID)     : 1\nSecurityVersion (ISVSVN)  : 3\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Use ",(0,i.jsx)(r.code,{children:"UniqueID"})," (i.e., ",(0,i.jsx)(r.code,{children:"MRENCLAVE"})," in Intel SGX speak) or the triplet of ",(0,i.jsx)(r.code,{children:"SignerID"})," (i.e., ",(0,i.jsx)(r.code,{children:"MRSIGNER"}),"), ",(0,i.jsx)(r.code,{children:"SecurityVersion"}),", and ",(0,i.jsx)(r.code,{children:"ProductID"})," to add an entry in the ",(0,i.jsx)(r.code,{children:"Packages"})," section."]}),"\n",(0,i.jsxs)(r.h3,{id:"step-22-define-the-parameters",children:[(0,i.jsx)(r.strong,{children:"Step 2.2:"})," Define the parameters"]}),"\n",(0,i.jsxs)(r.p,{children:["Now you can define with which parameters (i.e., files, environment variables, and command line arguments) your service is allowed to run. This is done in the ",(0,i.jsx)(r.code,{children:"Marbles"})," section of the manifest as is described in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/workflows/define-manifest#marbles",children:"writing a manifest hands-on"}),". When using EGo, define all TTLS connections as described in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/workflows/define-manifest#tls",children:"manifest hands-on"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Otherwise, as discussed in ",(0,i.jsx)(r.a,{href:"#make-your-service-use-the-provided-tls-credentials",children:"Step #1"}),", make sure that the TLS credentials for your service (i.e., ",(0,i.jsx)(r.code,{children:"MarbleRun.MarbleCert.Cert"})," and ",(0,i.jsx)(r.code,{children:"MarbleRun.MarbleCert.Private"}),") are injected such that your service finds them at runtime."]}),"\n",(0,i.jsxs)(r.h2,{id:"step-3-start-your-service",children:[(0,i.jsx)(r.strong,{children:"Step 3:"})," Start your service"]}),"\n",(0,i.jsx)(r.p,{children:"When you start your service, you need to pass in a couple of configuration parameters through environment variables. Here is an example:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"EDG_MARBLE_COORDINATOR_ADDR=coordinator-mesh-api.marblerun:2001 \\\nEDG_MARBLE_TYPE=mymarble \\\nEDG_MARBLE_UUID_FILE=$PWD/uuid \\\nEDG_MARBLE_DNS_NAMES=localhost,myservice \\\nerthost enclave.signed\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"erthost"})," is the generic host for EdgelessRT Marbles, which will load your ",(0,i.jsx)(r.code,{children:"enclave.signed"}),".\nFor EGo (",(0,i.jsx)(r.code,{children:"ego marblerun"}),"), Gramine (",(0,i.jsx)(r.code,{children:"gramine-sgx"}),"), and Occlum (",(0,i.jsx)(r.code,{children:"occlum run"}),") use their particular launch mechanism instead."]}),"\n",(0,i.jsx)(r.p,{children:"The environment variables have the following purposes."}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"EDG_MARBLE_COORDINATOR_ADDR"})," is the network address of the Coordinator's API for Marbles. When you deploy the Coordinator using the Helm repository as is described in the ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/deployment/kubernetes",children:"deploying MarbleRun hands-on"}),", the default address is ",(0,i.jsx)(r.code,{children:"coordinator-mesh-api.marblerun:2001"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"EDG_MARBLE_TYPE"})," needs to reference one entry from your manifest's ",(0,i.jsx)(r.code,{children:"Marbles"})," section."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"EDG_MARBLE_UUID_FILE"})," is the local file path where the Marble stores its UUID. Every instance of a Marble has its unique and public UUID. The file is needed to allow a Marble to restart under its UUID."]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"EDG_MARBLE_DNS_NAMES"})," is the list of DNS names and IPs the Coordinator will issue the Marble's certificate for."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Optionally, you can set the ",(0,i.jsx)(r.code,{children:"EDG_LOG_FORMAT"})," environment variable to ",(0,i.jsx)(r.code,{children:"json"})," to enable JSON structured logs for the Marble's startup code."]}),"\n",(0,i.jsxs)(r.h2,{id:"step-4-deploy-your-service-with-kubernetes",children:[(0,i.jsx)(r.strong,{children:"Step 4:"})," Deploy your service with Kubernetes"]}),"\n",(0,i.jsx)(r.p,{children:"Typically, you'll write a Kubernetes resource definition for your service, which you'll deploy with the Kubernetes CLI, Helm, or similar tools."}),"\n",(0,i.jsxs)(r.p,{children:['For your services to take advantage of MarbleRun, they need to be "added to the mesh" by having the data plane configuration injected into their pods.\nThis is typically done by labeling the deployment, or pod with the ',(0,i.jsx)(r.code,{children:"marblerun/marbletype"})," Kubernetes label.\nThis label triggers automatic configuration injection when the resources are created. (See ",(0,i.jsx)(r.a,{href:"/marblerun/pr-preview/pr-891/next/features/kubernetes-integration",children:"auto injection"})," for more on how this works.)"]}),"\n",(0,i.jsxs)(r.p,{children:["An example for a Marble of type ",(0,i.jsx)(r.code,{children:"web"})," could look like this:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: web\n  namespace: emojivoto\n  labels:\n    app.kubernetes.io/name: web\n    app.kubernetes.io/part-of: emojivoto\n    app.kubernetes.io/version: v1\n    marblerun/marbletype: web\n"})}),"\n",(0,i.jsx)(r.p,{children:"This will result in the following configuration being injected when your resources are created:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'spec:\n  containers:\n    - env:\n      - name: EDG_MARBLE_COORDINATOR_ADDR\n        value: coordinator-mesh-api.marblerun:2001\n      - name: EDG_MARBLE_TYPE\n        value: web\n      - name: EDG_MARBLE_DNS_NAMES\n        value: "web,web.emojivoto,web.emojivoto.svc.cluster.local"\n      - name: EDG_MARBLE_UUID_FILE\n        value: "$PWD/uuid"\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Refer to the ",(0,i.jsx)(r.a,{href:"https://github.com/edgelesssys/emojivoto",children:"emojivoto"})," app for complete Helm chart examples."]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);