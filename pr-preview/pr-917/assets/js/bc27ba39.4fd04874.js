"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9956],{28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>l});var t=r(96540);const s={},i=t.createContext(s);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:n},e.children)}},93943:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"building-marbles/gramine","title":"Building a service: Gramine","description":"Running a Gramine app with MarbleRun requires some changes to its manifest. These are explained in the following. See also the hello world example for a simple introduction, or the nginx and Redis examples for more detailed applications.","source":"@site/versioned_docs/version-1.3/building-marbles/gramine.md","sourceDirName":"building-marbles","slug":"/building-marbles/gramine","permalink":"/marblerun/pr-preview/pr-917/1.3/building-marbles/gramine","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/versioned_docs/version-1.3/building-marbles/gramine.md","tags":[],"version":"1.3","frontMatter":{},"sidebar":"docs","previous":{"title":"EGo","permalink":"/marblerun/pr-preview/pr-917/1.3/building-marbles/ego"},"next":{"title":"Occlum","permalink":"/marblerun/pr-preview/pr-917/1.3/building-marbles/occlum"}}');var s=r(74848),i=r(28453);const a={},l="Building a service: Gramine",o={},d=[{value:"Requirements",id:"requirements",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Entrypoint and argv",id:"entrypoint-and-argv",level:3},{value:"Host environment variables",id:"host-environment-variables",level:3},{value:"UUID file",id:"uuid-file",level:3},{value:"Remote attestation",id:"remote-attestation",level:3},{value:"Enclave size and threads",id:"enclave-size-and-threads",level:3},{value:"Secret files",id:"secret-files",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"aesm_service returned error: 30",id:"aesm_service-returned-error-30",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"building-a-service-gramine",children:"Building a service: Gramine"})}),"\n",(0,s.jsxs)(n.p,{children:["Running a Gramine app with MarbleRun requires some changes to its manifest. These are explained in the following. See also the ",(0,s.jsx)(n.a,{href:"https://github.com/edgelesssys/marblerun/tree/master/samples/gramine-hello",children:"hello world example"})," for a simple introduction, or the ",(0,s.jsx)(n.a,{href:"https://github.com/edgelesssys/marblerun/tree/master/samples/gramine-nginx",children:"nginx"})," and ",(0,s.jsx)(n.a,{href:"https://github.com/edgelesssys/marblerun/tree/master/samples/gramine-redis",children:"Redis"})," examples for more detailed applications."]}),"\n",(0,s.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,s.jsxs)(n.p,{children:["First, get Gramine up and running. Gramine is available ",(0,s.jsx)(n.a,{href:"https://github.com/gramineproject/gramine/releases",children:"as a Debian package"}),". Alternatively you can follow either the ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/latest/devel/building.html",children:"Building"})," or ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/latest/installation.html",children:"Cloud Deployment"})," guide to build and install Gramine from source."]}),"\n",(0,s.jsx)(n.p,{children:"Before running your application, make sure you got the prerequisites for ECDSA remote attestation installed on your system. You can collectively install them with the following command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo apt install libsgx-quote-ex-dev\n"})}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"entrypoint-and-argv",children:"Entrypoint and argv"}),"\n",(0,s.jsxs)(n.p,{children:["We provide the ",(0,s.jsx)(n.code,{children:"premain-libos"})," executable with the ",(0,s.jsx)(n.a,{href:"https://github.com/edgelesssys/marblerun/releases",children:"MarbleRun Releases"}),". It will contact the Coordinator, set up the environment, and run the actual application."]}),"\n",(0,s.jsxs)(n.p,{children:["Set the premain executable as ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/manifest-syntax.html#libos-entrypoint",children:"the entry point"})," of the Gramine application and place the actual entry point ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/manifest-syntax.html#command-line-arguments",children:"in argv0"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'libos.entrypoint = "file:premain-libos"\n\n# argv0 needs to contain the name of your executable\nloader.argv = ["hello"]\n\n# add the premain to the list of trusted files\nsgx.trusted_files = [\n    # ...\n    "file:premain-libos"\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:"After the premain is done running, it will automatically spawn your application."}),"\n",(0,s.jsx)(n.h3,{id:"host-environment-variables",children:"Host environment variables"}),"\n",(0,s.jsxs)(n.p,{children:["By default, environment variables from the host won't be passed to the application.\nGramine allows to ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/manifest-syntax.html#environment-variables",children:"pass through whitelisted environment variables from the host"}),".\nThe premain needs access to the following ",(0,s.jsx)(n.a,{href:"/marblerun/pr-preview/pr-917/1.3/workflows/add-service#step-3-start-your-service",children:"environment variables for configuration"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:"loader.env.EDG_MARBLE_TYPE = { passthrough = true }\nloader.env.EDG_MARBLE_COORDINATOR_ADDR = { passthrough = true }\nloader.env.EDG_MARBLE_UUID_FILE = { passthrough = true }\nloader.env.EDG_MARBLE_DNS_NAMES = { passthrough = true }\n"})}),"\n",(0,s.jsx)(n.h3,{id:"uuid-file",children:"UUID file"}),"\n",(0,s.jsx)(n.p,{children:"The Marble must be able to store its UUID:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'sgx.allowed_files = [\n    # ...\n    "file:uuid"\n]\n'})}),"\n",(0,s.jsx)(n.h3,{id:"remote-attestation",children:"Remote attestation"}),"\n",(0,s.jsxs)(n.p,{children:["The Marble will send an SGX quote to the Coordinator for remote attestation using ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/manifest-syntax.html#attestation-and-quotes",children:"DCAP attestation"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'sgx.remote_attestation = "dcap"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"enclave-size-and-threads",children:"Enclave size and threads"}),"\n",(0,s.jsx)(n.p,{children:"The premain process is written in Go. The enclave needs to have enough resources for the Go runtime:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'sgx.enclave_size = "1024M"\nsgx.thread_num = 16\n'})}),"\n",(0,s.jsx)(n.p,{children:"If your application has high memory demands, you may need to increase the size even further."}),"\n",(0,s.jsx)(n.h3,{id:"secret-files",children:"Secret files"}),"\n",(0,s.jsxs)(n.p,{children:["A Marble's secrets, e.g. a certificate and private key, can be provisioned as files. You can utilize Gramine's in-memory filesystem ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/latest/manifest-syntax.html#fs-mount-points",children:(0,s.jsx)(n.code,{children:"tmpfs"})}),", so the secrets will never show up on the host's file system :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'fs.mounts = [\n    # ...\n    { type = "tmpfs", path = "/secrets" },\n    # ...\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:"You can specify the files' content in the MarbleRun manifest:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'...\n    "Parameters": {\n        "Files": {\n            "/secrets/server.crt": "{{ pem .Secrets.serverCert.Cert }}",\n            "/secrets/server.key": "{{ pem .Secrets.serverCert.Private }}"\n        }\n    }\n...\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Gramine also allows to store files ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/manifest-syntax.html#encrypted-files",children:"encrypted on the host's file system"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'fs.mounts = [\n  # ...\n  { type = "encrypted", path = "/secrets", uri = "file:/path/to/local/directory", key_name = "[KEY_NAME]" },\n  # ...\n]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Gramine provides access to a pseudo filesystem for ",(0,s.jsx)(n.a,{href:"https://gramine.readthedocs.io/en/v1.3/attestation.html#low-level-dev-attestation-interface",children:"setting the encryption key"}),".\nMarbleRun can set up your enclave with keys at runtime by specifying them in the MarbleRun manifest:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'...\n    "Parameters": {\n        "Files": {\n            "/dev/attestation/[KEY_NAME]": "{{ raw .Secrets.encryptedFilesKey }}"\n        }\n    }\n...\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You can see how this is done in the ",(0,s.jsx)(n.a,{href:"https://github.com/edgelesssys/marblerun/tree/master/samples/gramine-nginx",children:"nginx example"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"aesm_service-returned-error-30",children:"aesm_service returned error: 30"}),"\n",(0,s.jsx)(n.p,{children:"If you receive the following error message on launch:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"aesm_service returned error: 30\nload_enclave() failed with error -1\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Make sure you installed the Intel AESM ECDSA plugins on your machine. You can do this by installing the ",(0,s.jsx)(n.code,{children:"libsgx-quote-dev"})," package mentioned in the requirements above."]}),"\n",(0,s.jsxs)(n.p,{children:["If you are running your application in a container, you will need to mount the aesm socket. The socket is located at ",(0,s.jsx)(n.code,{children:"/var/run/aesmd/"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["If you are deploying your application on Kubernetes with the ",(0,s.jsx)(n.a,{href:"https://intel.github.io/intel-device-plugins-for-kubernetes/cmd/sgx_plugin/README.html",children:"Intel SGX device plugin"})," installed, the socket is automatically mounted by setting the ",(0,s.jsx)(n.code,{children:"sgx.intel.com/quote-provider: aesmd"})," annotation for your deployment:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: gramine-marble\n  labels:\n    marblerun/marbletype: gramine-marble\n  annotations:\n    sgx.intel.com/quote-provider: aesmd\nspec:\n  container:\n    - name: gramine-marble\n      image: localhost/gramine-marble\n      resources:\n        limits:\n          sgx.intel.com/epc: 10Mi\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);