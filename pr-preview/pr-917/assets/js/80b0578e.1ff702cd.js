"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1276],{6053:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"workflows/backup","title":"Backing up and restoring MarbleRun state","description":"In a production environment, you should regularly back up the state of the MarbleRun Coordinator to be able to restore it in case of failure. Backup is easy, but there are differences based on how you deployed MarbleRun.","source":"@site/versioned_docs/version-1.9/workflows/backup.md","sourceDirName":"workflows","slug":"/workflows/backup","permalink":"/marblerun/pr-preview/pr-917/workflows/backup","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/versioned_docs/version-1.9/workflows/backup.md","tags":[],"version":"1.9","frontMatter":{},"sidebar":"docs","previous":{"title":"Monitoring and logging","permalink":"/marblerun/pr-preview/pr-917/workflows/monitoring"},"next":{"title":"User authentication","permalink":"/marblerun/pr-preview/pr-917/workflows/user-authentication"}}');var a=r(74848),o=r(28453);const s={},i="Backing up and restoring MarbleRun state",l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Backing up the Coordinator state",id:"backing-up-the-coordinator-state",level:2},{value:"Restoring the Coordinator state",id:"restoring-the-coordinator-state",level:2},{value:"Things to consider",id:"things-to-consider",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{TabItem:r,Tabs:t}=n;return r||h("TabItem",!0),t||h("Tabs",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"backing-up-and-restoring-marblerun-state",children:"Backing up and restoring MarbleRun state"})}),"\n",(0,a.jsx)(n.p,{children:"In a production environment, you should regularly back up the state of the MarbleRun Coordinator to be able to restore it in case of failure. Backup is easy, but there are differences based on how you deployed MarbleRun."}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.p,{children:["Restoring a backup includes ",(0,a.jsx)(n.a,{href:"/marblerun/pr-preview/pr-917/features/recovery",children:"recovering the Coordinator"}),", so you need to ",(0,a.jsx)(n.a,{href:"/marblerun/pr-preview/pr-917/workflows/define-manifest#recoverykeys",children:"define recovery keys"})," in the manifest."]}),"\n",(0,a.jsx)(n.h2,{id:"backing-up-the-coordinator-state",children:"Backing up the Coordinator state"}),"\n",(0,a.jsx)(n.p,{children:"The Coordinator supports live backup, so you can back up its state without stopping it."}),"\n",(0,a.jsxs)(t,{groupId:"deployment",children:[(0,a.jsxs)(r,{value:"distributed",label:"Kubernetes, distributed Coordinator",children:[(0,a.jsxs)(n.p,{children:["Make a copy of the ",(0,a.jsx)(n.code,{children:"marblerun-state"})," Secret in the ",(0,a.jsx)(n.code,{children:"marblerun"})," namespace:"]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl -n marblerun get secret marblerun-state -o yaml > marblerun-state-backup.yaml\n"})})]}),(0,a.jsxs)(r,{value:"single",label:"Kubernetes, single Coordinator",children:[(0,a.jsxs)(n.p,{children:["The state is stored on a PersistentVolume bound to the PersistentVolumeClaim ",(0,a.jsx)(n.code,{children:"coordinator-pv-claim"})," in the ",(0,a.jsx)(n.code,{children:"marblerun"})," namespace.\nCheck the documentation of your Kubernetes distribution on the available options to back up PersistentVolumes."]}),(0,a.jsxs)(n.p,{children:["Alternatively, you can copy the ",(0,a.jsx)(n.code,{children:"sealed_data"})," file from the PersistentVolume (via the Coordinator Pod) to your machine:"]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"podname=$(kubectl -n marblerun get pods -l app.kubernetes.io/name=coordinator -o jsonpath='{.items[0].metadata.name}')\nkubectl -n marblerun cp $podname:/coordinator/data/sealed_data sealed_data_backup\n"})})]}),(0,a.jsx)(r,{value:"standalone",label:"Standalone",children:(0,a.jsxs)(n.p,{children:["Make a copy of the ",(0,a.jsx)(n.code,{children:"sealed_data"})," file in the ",(0,a.jsx)(n.code,{children:"marblerun-coordinator-data"})," directory."]})})]}),"\n",(0,a.jsx)(n.h2,{id:"restoring-the-coordinator-state",children:"Restoring the Coordinator state"}),"\n",(0,a.jsxs)(t,{groupId:"deployment",children:[(0,a.jsxs)(r,{value:"distributed",label:"Kubernetes, distributed Coordinator",children:[(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Stop all Coordinator instances:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl -n marblerun scale --replicas=0 deployment/marblerun-coordinator\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Apply the state from the backup:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f marblerun-state-backup.yaml\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Scale the Coordinator back to the desired number of instances:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl -n marblerun scale --replicas=3 deployment/marblerun-coordinator\n"})}),"\n"]}),"\n"]}),(0,a.jsxs)(n.admonition,{type:"tip",children:[(0,a.jsx)(n.p,{children:"If you want to restore MarbleRun in a fresh cluster, you can apply the state from the backup before installing MarbleRun:"}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl create ns marblerun\nkubectl apply -f marblerun-state-backup.yaml\nmarblerun install ...\n"})})]})]}),(0,a.jsx)(r,{value:"single",label:"Kubernetes, single Coordinator",children:(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"If you have a backup of the PersistentVolume, stop the Coordinator instance, restore the volume, and start the Coordinator again."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["If you have a backup of the ",(0,a.jsx)(n.code,{children:"sealed_data"})," file, copy it to the PersistentVolume and then restart the Coordinator:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"podname=$(kubectl -n marblerun get pods -l app.kubernetes.io/name=coordinator -o jsonpath='{.items[0].metadata.name}')\nkubectl -n marblerun cp sealed_data_backup $podname:/coordinator/data/sealed_data\nkubectl -n marblerun delete pod $podname\n"})}),"\n"]}),"\n"]})}),(0,a.jsx)(r,{value:"standalone",label:"Standalone",children:(0,a.jsxs)(n.p,{children:["Stop the Coordinator, copy back the ",(0,a.jsx)(n.code,{children:"sealed_data"})," file to the ",(0,a.jsx)(n.code,{children:"marblerun-coordinator-data"})," directory, and start the Coordinator again."]})})]}),"\n",(0,a.jsxs)(n.p,{children:["After restoring the state from the backup, you may need to ",(0,a.jsx)(n.a,{href:"/marblerun/pr-preview/pr-917/workflows/recover-coordinator",children:"recover the Coordinator"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"things-to-consider",children:"Things to consider"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Backup events"}),": In addition to regular backups, you may want to back up the state after significant changes, such as manifest updates."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Cluster backup"}),": If you use a Kubernetes cluster backup solution, the MarbleRun state may already be included in that backup. You should check if restoring and recovering the Coordinator works as expected."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Marbles"}),": Marbles may have state and that state may depend on the Coordinator state (e.g., secrets, monotonic counters). If so, you may need to back up Marble state and Coordinator state together."]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}function h(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>i});var t=r(96540);const a={},o=t.createContext(a);function s(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);