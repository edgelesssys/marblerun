"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9973],{28453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>c});var o=n(96540);const s={},t=o.createContext(s);function i(e){const r=o.useContext(t);return o.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(t.Provider,{value:r},e.children)}},29981:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"workflows/recover-coordinator","title":"Recovering the Coordinator","description":"Different situations require the recovery of the Coordinator.","source":"@site/docs/workflows/recover-coordinator.md","sourceDirName":"workflows","slug":"/workflows/recover-coordinator","permalink":"/marblerun/pr-preview/pr-926/next/workflows/recover-coordinator","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/docs/workflows/recover-coordinator.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Update a deployment","permalink":"/marblerun/pr-preview/pr-926/next/workflows/updates"},"next":{"title":"Configure Azure HSM sealing","permalink":"/marblerun/pr-preview/pr-926/next/workflows/hsm-sealing"}}');var s=n(74848),t=n(28453);const i={},c="Recovering the Coordinator",a={},l=[{value:"Multi-party recovery",id:"multi-party-recovery",level:2},{value:"Example",id:"example",level:3},{value:"Offline recovery secret signing",id:"offline-recovery-secret-signing",level:2}];function d(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"recovering-the-coordinator",children:"Recovering the Coordinator"})}),"\n",(0,s.jsxs)(r.p,{children:["Different situations require the ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/features/recovery",children:"recovery"})," of the Coordinator.\nIf the Coordinator fails to unseal its state, it will enter recovery mode."]}),"\n",(0,s.jsx)(r.admonition,{type:"tip",children:(0,s.jsxs)(r.p,{children:["Use ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/features/recovery#distributed-coordinator",children:"distributed Coordinator instances"})," to reduce the occurrence of events that require manual recovery."]})}),"\n",(0,s.jsxs)(r.p,{children:["You need the corresponding private key to the ",(0,s.jsxs)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/define-manifest#recoverykeys",children:[(0,s.jsx)(r.code,{children:"RecoveryKeys"})," defined in the manifest"]})," and the ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/set-manifest",children:"recovery secret returned to you during the initial upload of the manifest"}),"."]}),"\n",(0,s.jsx)(r.admonition,{type:"info",children:(0,s.jsxs)(r.p,{children:["If you don't want or can't recover the old state, you can also dismiss it by ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/set-manifest",children:"uploading a new manifest"}),".\nThe old state will be overwritten on disk, and recovery won't be available anymore."]})}),"\n",(0,s.jsx)(r.p,{children:"To recover the Coordinator, you need to decode your recovery secret and upload it using the MarbleRun CLI."}),"\n",(0,s.jsxs)(r.p,{children:["Assuming you named your recovery key ",(0,s.jsx)(r.code,{children:"recoverKey1"})," in the manifest, and you saved the output from the manifest upload step in a file called ",(0,s.jsx)(r.code,{children:"recovery_data"}),", decode your secret with the following command:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"jq -r '.RecoverySecrets.recoverKey1' recovery_data | openssl base64 -d > recovery_key_encrypted\n"})}),"\n",(0,s.jsx)(r.p,{children:"Then decrypt and upload the extracted secret using the MarbleRun CLI:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"marblerun recover recovery_key_encrypted $MARBLERUN --key private_key.pem\n"})}),"\n",(0,s.jsx)(r.p,{children:"On success, the Coordinator applies the sealed state again. If the Coordinator can't restore the state with the uploaded key, an error will be returned in the logs, and the recovery endpoint will stay open for further interaction."}),"\n",(0,s.jsx)(r.h2,{id:"multi-party-recovery",children:"Multi-party recovery"}),"\n",(0,s.jsxs)(r.p,{children:["If you've ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/define-manifest#multi-party-recovery",children:"configured your MarbleRun deployment for multi-party recovery"}),", send each party the corresponding ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/set-manifest",children:"recovery secret"}),". Ask them to perform the steps above. Once all parties have uploaded their secrets, the Coordinator recovers the sealed state and continues its operations."]}),"\n",(0,s.jsxs)(r.admonition,{type:"note",children:[(0,s.jsxs)(r.p,{children:["If your MarbleRun deployment uses ",(0,s.jsx)(r.a,{href:"/marblerun/pr-preview/pr-926/next/features/recovery#distributed-coordinator",children:"distributed Coordinator instances"}),", make sure all parties send their secrets to the same Coordinator instance.\nOne way to achieve this is scaling the Coordinator to a single instance:"]}),(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl scale --replicas=1 -n marblerun deployment/marblerun-coordinator\n"})}),(0,s.jsx)(r.p,{children:"After recovery, you can scale the Coordinator back to the desired number of instances."})]}),"\n",(0,s.jsx)(r.admonition,{type:"tip",children:(0,s.jsxs)(r.p,{children:["Use the ",(0,s.jsxs)(r.a,{href:"/marblerun/pr-preview/pr-926/next/workflows/define-manifest#config",children:[(0,s.jsx)(r.code,{children:"RecoveryThreshold"})," manifest option"]})," to set the number of secrets required to recover the Coordinator."]})}),"\n",(0,s.jsx)(r.h3,{id:"example",children:"Example"}),"\n",(0,s.jsx)(r.p,{children:"The following gives an example of a multi-party recovery workflow."}),"\n",(0,s.jsxs)(r.p,{children:["Assume the following ",(0,s.jsx)(r.code,{children:"RecoveryKeys"})," were set in the manifest:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:'    "RecoveryKeys": {\n        "alice": "-----BEGIN PUBLIC KEY-----\\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAk/6gfFF+cbcTlj8MT+4M\\njjpM+suTwNM9gjv47EAAQ==\\n-----END PUBLIC KEY-----\\n",\n        "bob": "-----BEGIN PUBLIC KEY-----\\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAsnOEAvynVrbgLdp0lwcp\\nk2k04+n4op6tp1Yw2OaDbEAAQ==\\n-----END PUBLIC KEY-----\\n"\n    }\n'})}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsxs)(r.p,{children:["The Coordinator returned the following ",(0,s.jsx)(r.code,{children:"RecoverySecrets"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:'$ marblerun manifest set manifest.json $MARBLERUN\n...\n{"RecoverySecrets":{"alice":"EbkX/skIPrJISf8PiXdzRIKnwQyJ+VejtGzHGfES5NIPuCeEFedqgCVDk=","bob":"bvPzio4A4SvzeHajsb+dFDpDarErcU9wMR0V9hyHtG2lC4ZfyrYjDBE7wtis3eOPgDaMG/HCt="}}\n'})}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsxs)(r.p,{children:["Alice decrypts and uploads her recovery key using her private key ",(0,s.jsx)(r.code,{children:"private_key.pem"})," as follows:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:'$ marblerun status $MARBLERUN\n1: Coordinator is in recovery mode. Either upload a key to unseal the saved state, or set a new manifest. For more information on how to proceed, consult the documentation.\n$ echo "EbkX/skIPrJISf8PiXdzRIKnwQyJ+VejtGzHGfES5NIPuCeEFedqgCVDk=" > recovery_data\n$ openssl base64 -d -in recovery_data > recovery_key_encrypted\n$ marblerun recover recovery_key_encrypted $MARBLERUN --key private_key.pem\nSuccessfully verified Coordinator, now uploading key\nSecret was processed successfully. Upload the next secret. Remaining secrets: 1\n'})}),"\n",(0,s.jsx)(r.p,{children:"The Coordinator log shows the following:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{"level":"info","ts":1674206799.524596,"caller":"clientapi/clientapi.go:234","msg":"Recover called"}\n{"level":"info","ts":1674206799.524596,"caller":"clientapi/clientapi.go:253","msg":"Recover: recovery incomplete, more keys needed","remaining":1}\n'})}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsx)(r.p,{children:"Bob does the same with his key to complete the recovery procedure:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:'$ marblerun status $MARBLERUN\n1: Coordinator is in recovery mode. Either upload a key to unseal the saved state, or set a new manifest. For more information on how to proceed, consult the documentation.\n$ echo "bvPzio4A4SvzeHajsb+dFDpDarErcU9wMR0V9hyHtG2lC4ZfyrYjDBE7wtis3eOPgDaMG/HCt=" > recovery_data\n$ openssl base64 -d -in recovery_data > recovery_key_encrypted\n$ marblerun recover recovery_key_encrypted $MARBLERUN --key private_key.pem\nSuccessfully verified Coordinator, now uploading key\nRecovery successful.\n$ marblerun status $MARBLERUN\n3: Coordinator is running correctly and ready to accept marbles.\n'})}),"\n",(0,s.jsx)(r.p,{children:"The Coordinator log shows the following:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{"level":"info","ts":1674206836.5523517,"caller":"clientapi/clientapi.go:234","msg":"Recover called"}\n{"level":"info","ts":1674206836.5563517,"caller":"core/core.go:261","msg":"generating quote"}\n{"level":"info","ts":1674206836.6043515,"caller":"clientapi/clientapi.go:281","msg":"Recover successful"}\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"offline-recovery-secret-signing",children:"Offline recovery secret signing"}),"\n",(0,s.jsx)(r.p,{children:"When recovering a Coordinator, the CLI decrypts and signs the secret with your private recovery key before sending it to the Coordinator over a TLS connection.\nDepending on your deployment, it may not be acceptable to have your private key or the decrypted recovery secret on a machine connected to the internet.\nFor this case, you can retrieve a public key from the Coordinator to encrypt your signed recovery secret on an air-gapped system."}),"\n",(0,s.jsx)(r.p,{children:"The following gives an example of how to recover MarbleRun with your private recovery key on an air-gapped system."}),"\n",(0,s.jsxs)(r.p,{children:["Assume the following ",(0,s.jsx)(r.code,{children:"RecoveryKeys"})," was set in the manifest:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:'    "RecoveryKeys": {\n        "alice": "-----BEGIN PUBLIC KEY-----\\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAk/6gfFF+cbcTlj8MT+4M\\njjpM+suTwNM9gjv47EAAQ==\\n-----END PUBLIC KEY-----\\n"\n    }\n'})}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsxs)(r.p,{children:["The Coordinator returned the following ",(0,s.jsx)(r.code,{children:"RecoverySecrets"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:'$ marblerun manifest set manifest.json $MARBLERUN\n...\n{"RecoverySecrets":{"alice":"EbkX/skIPrJISf8PiXdzRIKnwQyJ+VejtGzHGfES5NIPuCeEFedqgCVDk="}}\n'})}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsx)(r.p,{children:"On a machine with access to the Coordinator, retrieve the Coordinator's recovery public key:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:"$ marblerun status $MARBLERUN\n1: Coordinator is in recovery mode. Either upload a key to unseal the saved state, or set a new manifest. For more information on how to proceed, consult the documentation.\n$ marblerun recover-with-signature public-key $MARBLERUN --output recovery-public.pem\n"})}),"\n",(0,s.jsxs)(r.p,{children:["This will save the Coordinator's recovery public key to ",(0,s.jsx)(r.code,{children:"recovery-public.pem"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsx)(r.p,{children:"Move the recovery public key to the system with access to your private recovery key"}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsx)(r.p,{children:"Sign your recovery secret:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:'echo "EbkX/skIPrJISf8PiXdzRIKnwQyJ+VejtGzHGfES5NIPuCeEFedqgCVDk=" > recovery_data\nopenssl base64 -d -in recovery_data > recovery_key_encrypted\nmarblerun recover-with-signature sign-secret recovery_key_encrypted --key private.pem --output recovery-secret.sig\n'})}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsx)(r.p,{children:"Encrypt your recovery secret with the Coordinator's public key"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:"marblerun recover-with-signature encrypt-secret recovery_key_encrypted --coordinator-pub-key recovery-public.pem --key private.pem --output recovery-secret.enc\n"})}),"\n"]}),"\n",(0,s.jsxs)(r.li,{children:["\n",(0,s.jsxs)(r.p,{children:["Move your encrypted recovery secret, ",(0,s.jsx)(r.code,{children:"recovery-secret.enc"}),", and its matching signature, ",(0,s.jsx)(r.code,{children:"recovery-secret.sig"})," back to a machine with access to the Coordinator"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell-session",children:"marblerun recover-with-signature recovery-secret.enc $MARBLERUN --signature recovery-secret.sig\n"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);