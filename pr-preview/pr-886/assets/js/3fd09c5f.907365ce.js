"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8865],{28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>i});var a=r(96540);const s={},t=a.createContext(s);function o(e){const n=a.useContext(t);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(t.Provider,{value:n},e.children)}},57213:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"features/hsm-sealing","title":"Azure managed HSM integration","description":"MarbleRun has an integration for Azure Managed HSM.","source":"@site/docs/features/hsm-sealing.md","sourceDirName":"features","slug":"/features/hsm-sealing","permalink":"/marblerun/pr-preview/pr-886/next/features/hsm-sealing","draft":false,"unlisted":false,"editUrl":"https://github.com/edgelesssys/marblerun/edit/master/docs/docs/features/hsm-sealing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Kubernetes integration","permalink":"/marblerun/pr-preview/pr-886/next/features/kubernetes-integration"},"next":{"title":"Supported runtimes","permalink":"/marblerun/pr-preview/pr-886/next/features/runtimes"}}');var s=r(74848),t=r(28453);const o={},i="Azure managed HSM integration",l={},c=[{value:"Setting up Azure Managed HSM for MarbleRun",id:"setting-up-azure-managed-hsm-for-marblerun",level:2},{value:"Configuring MarbleRun to use Azure Managed HSM",id:"configuring-marblerun-to-use-azure-managed-hsm",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...e.components},{TabItem:r,Tabs:a}=n;return r||h("TabItem",!0),a||h("Tabs",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"azure-managed-hsm-integration",children:"Azure managed HSM integration"})}),"\n",(0,s.jsxs)(n.p,{children:["MarbleRun has an integration for ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/key-vault/managed-hsm/overview",children:"Azure Managed HSM"}),".\nThis feature allows users to use an HSM key to encrypt data managed by MarbleRun,\nusing the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/confidential-computing/concept-skr-attestation",children:"Secure Key Release (SKR)"})," feature of Azure Managed HSM.\nSKR allows users to define a policy for a key in the HSM that enables the key to be used only by applications that meet the attestation requirements defined in the policy."]}),"\n",(0,s.jsxs)(n.p,{children:["To enable the feature for your MarbleRun deployment, enable the ",(0,s.jsxs)(n.a,{href:"/marblerun/pr-preview/pr-886/next/workflows/define-manifest#config",children:[(0,s.jsx)(n.code,{children:"AzureHSMSealing"})," feature gate in your manifest"]}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"setting-up-azure-managed-hsm-for-marblerun",children:"Setting up Azure Managed HSM for MarbleRun"}),"\n",(0,s.jsxs)(n.p,{children:["The following gives a brief overview of how to set up an HSM for use with MarbleRun.\nView the ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/key-vault/managed-hsm/quick-create-cli",children:"official documentation"})," for more details on how to provision and manage HSMs."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Start by setting up a resource group for your HSM:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'az group create --name "marblerun-hsm" --location "uksouth"\n'})}),"\n",(0,s.jsx)(n.p,{children:"The location should ideally match the location of your MarbleRun deployment."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create the HSM:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'user_oid=$(az ad signed-in-user show --query id -o tsv)\naz keyvault create --hsm-name "MarbleRunHSM" --resource-group "marblerun-hsm" --location "uksouth" --administrators $user_oid --retention-days 7\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Activate the HSM"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mkdir hsm\nopenssl req -newkey rsa:2048 -nodes -keyout hsm/cert_0.key -x509 -days 365 -out hsm/cert_0.cer\nopenssl req -newkey rsa:2048 -nodes -keyout hsm/cert_1.key -x509 -days 365 -out hsm/cert_1.cer\nopenssl req -newkey rsa:2048 -nodes -keyout hsm/cert_2.key -x509 -days 365 -out hsm/cert_2.cer\n\naz keyvault security-domain download --hsm-name MarbleRunHSM --sd-wrapping-keys ./hsm/cert_0.cer ./hsm/cert_1.cer ./hsm/cert_2.cer --sd-quorum 2 --security-domain-file hsm/MarbleRunHSM-SD.json\n"})}),"\n",(0,s.jsx)(n.p,{children:"Store the certificates and security domain file securely. They're needed for disaster recovery of your HSM."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Assign the yourself permissions to create keys in the HSM:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'az keyvault role assignment create --assignee $user_oid --role "Managed HSM Crypto User" --hsm-name MarbleRunHSM --scope /\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create a key release policy for your key"}),"\n",(0,s.jsxs)(n.p,{children:["The key release policy controls what enclaves are allowed to access the key it's bound to.\nFor more details on how to configure your policies, see ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/confidential-computing/skr-policy-examples",children:"Azure's policy examples"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Make sure that ",(0,s.jsx)(n.code,{children:"authority"})," matches the location you are deploying MarbleRun to."]}),"\n",(0,s.jsxs)(n.p,{children:["The following policy allows a v1.8.0 MarbleRun Coordinator deployed in the UK South region to access the key.\nSave it a file named ",(0,s.jsx)(n.code,{children:"policy.json"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "version": "1.0.0",\n    "anyOf": [\n        {\n            "authority": "https://shareduks.uks.attest.azure.net",\n            "allOf": [\n                {\n                    "claim": "x-ms-sgx-mrsigner",\n                    "equals": "43361affedeb75affee9baec7e054a5e14883213e5a121b67d74a0e12e9d2b7a"\n                },\n                {\n                    "claim": "x-ms-sgx-svn",\n                    "greaterOrEquals": 2\n                },\n                {\n                    "claim": "x-ms-sgx-product-id",\n                    "greaterOrEquals": 3\n                },\n                {\n                    "claim": "x-ms-sgx-is-debuggable",\n                    "equals": false\n                }\n            ]\n        }\n    ]\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create a key for MarbleRun in the HSM"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'az keyvault key create --exportable true --hsm-name "MarbleRunHSM" --kty OCT-HSM --name "marblerun-skr-key" --policy ./policy.json\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create a Service Principal for the MarbleRun Coordinator to access the HSM"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'az ad sp create-for-rbac --name "marblerun-coordinator-hsm-sp" > hsm/coordinator-sp-credentials.json\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:'Assign the "Managed HSM Crypto Service Release User" role to the Service Principal'}),"\n",(0,s.jsx)(n.p,{children:"This role allows the Service Principal to request key release of the key we created earlier.\nTo actually receive the key, the request must be made from an enclave that meets the requirements from the attestation policy."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'hsm_id=$(az keyvault show --hsm-name MarbleRunHSM --query id -o tsv)\napp_id=$(az ad sp list --display-name "marblerun-coordinator-hsm-sp" --query "[].id" -o tsv)\naz keyvault role assignment create --assignee-object-id $app_id --assignee-principal-type ServicePrincipal --role "Managed HSM Crypto Service Release User" --hsm-name MarbleRunHSM --scope /keys/marblerun-skr-key\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configuring-marblerun-to-use-azure-managed-hsm",children:"Configuring MarbleRun to use Azure Managed HSM"}),"\n",(0,s.jsx)(n.p,{children:"With the HSM set up, MarbleRun is now ready to request the key for sealing.\nFor this, the Coordinator needs credentials for the Service Principal and information about how to retrieve the key."}),"\n",(0,s.jsx)(n.p,{children:"Retrieve the credentials from the Service Principal JSON file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"client_id=$(jq -r '.appId' hsm/coordinator-sp-credentials.json)\nclient_secret=$(jq -r '.password' hsm/coordinator-sp-credentials.json)\ntenant_id=$(jq -r '.tenant' hsm/coordinator-sp-credentials.json)\n\nvault_url=$(az keyvault show --hsm-name MarbleRunHSM --query 'properties.hsmUri' -o tsv)\n"})}),"\n",(0,s.jsxs)(a,{groupId:"installation",children:[(0,s.jsxs)(r,{value:"helm",label:"Helm",children:[(0,s.jsxs)(n.p,{children:["Add the following to your Helm's ",(0,s.jsx)(n.code,{children:"values.yaml"})," file:"]}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'coordinator:\n    azureCredentials:\n        clientID: ${client_id}\n        tenantID: ${tenant_id}\n        clientSecret: ${client_secret}\n        # Optionally, set "secretName" to the name of a pre-configured secret\n        # containing AZURE_CLIENT_ID, AZURE_TENANT_ID, and AZURE_CLIENT_SECRET\n        # secretName: ""\n    hsm:\n        keyName: "marblerun-skr-key"\n        vaultURL: ${vault_url}\n        # Make sure this matches the location of your deployment, and the value you set in the key policy\n        maaURL: "https://shareduks.uks.attest.azure.net"\n        # Optionally, set to use a specific key version\n        keyVersion: ""\n'})})]}),(0,s.jsxs)(r,{value:"standalone",label:"Standalone",children:[(0,s.jsx)(n.p,{children:"Set the following environment variables to provided the needed information:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Azure credentials\nexport EDG_AZURE_CLIENT_ID=${client_id}\nexport EDG_AZURE_CLIENT_SECRET=${client_secret}\nexport EDG_AZURE_TENANT_ID=${tenant_id}\n\n# HSM key information\nexport EDG_AZURE_HSM_KEY_NAME="marblerun-skr-key"\nexport EDG_AZURE_HSM_KEY_VERSION="" # Optionally, set to use a specific key version\nexport EDG_AZURE_HSM_VAULT_URL=${vault_url}\n\n# MAA URL. Make sure this matches the location of your deployment, and the value you set in the key policy\nexport EDG_MAA_URL="https://shareduks.uks.attest.azure.net"\n'})})]})]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}function h(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);